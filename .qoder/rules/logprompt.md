---
trigger: always_on
alwaysApply: true
---

# 📋 股票分析系统开发规范

## 1️⃣ 变更日志管理规范

### 📌 核心原则
每次执行用户请求后，必须将处理过程和结果记录到项目根目录的 `CHANGELOG.md` 文件中，确保所有操作可追溯。
每次先通过shell模式从系统中获取时间，以北京时间做记录

**文件修改铁律：只追加不修改**
- ✅ 允许：在文件最开头（标题后第一条记录之前）插入新内容
- ❌ 禁止：修改、删除、重新排序任何原有内容
- ✅ 目的：保持历史记录的完整性和可追溯性

### 📚 Few-Shot 示例教学

#### ✅ 正确示例（必须遵循）

**原文件结构：**
```markdown
# 📋 Stock Analysis System - Change Log

## [2025-11-03] 20:30:00
### 📝 用户请求
添加遗漏的参数...
---

## [2025-10-31] 23:45:00
### 📝 用户请求
Git忽略配置...
---
```

**正确操作（新增2025-11-07记录）：**
```markdown
# 📋 Stock Analysis System - Change Log

## [2025-11-07] 15:30:00          ← ✅ 新记录插入在最顶部
### 📝 用户请求
优化规则文件...
### 🔧 处理过程
...
### ✅ 处理结果
...
### 🏷️ 标签
...
---

## [2025-11-03] 20:30:00          ← ✅ 原记录完全不动（包括空格、换行）
### 📝 用户请求
添加遗漏的参数...
---

## [2025-10-31] 23:45:00          ← ✅ 原记录完全不动
### 📝 用户请求
Git忽略配置...
---
```

**关键点：**
- 新记录在标题后、首条原记录前
- 原记录的**每一个字符**（标题、内容、标签、分隔符）完全保持原样
- 记录顺序：新 → 旧（时间倒序排列）

---

#### ❌ 错误示例1：修改了原有内容

```markdown
# 📋 Stock Analysis System - Change Log

## [2025-11-07] 15:30:00
...

## [2025-11-03] 20:30:00（已完成） ← ❌ 修改了原标题
### 📝 用户请求
添加**所有**遗漏的参数...        ← ❌ 修改了原内容
---
```

**错误原因：**
- 在原标题中添加了"（已完成）"
- 修改了原文字"添加遗漏的参数" → "添加**所有**遗漏的参数"
- 违反了"一字不改"原则

---

#### ❌ 错误示例2：删除了原有记录

```markdown
# 📋 Stock Analysis System - Change Log

## [2025-11-07] 15:30:00
...

## [2025-11-03] 20:30:00
...

[删除了2025-10-31的记录]  ← ❌ 删除历史记录
```

**错误原因：**
- 删除了10-31的历史记录
- 破坏了历史的完整性

---

#### ❌ 错误示例3：调整了原记录顺序

```markdown
# 📋 Stock Analysis System - Change Log

## [2025-11-07] 15:30:00
...

## [2025-10-31] 23:45:00  ← ❌ 与11-03调换了位置
...

## [2025-11-03] 20:30:00
...
```

**错误原因：**
- 虽未修改文字，但改变了原有的记录顺序
- 原顺序应为：11-03 → 10-31

---

### 🔧 实施方法

使用 `search_replace` 工具时的正确模板：

```python
{
    "file_path": "/path/to/CHANGELOG.md",
    "replacements": [{
        "original_text": "# 📋 Stock Analysis System - Change Log\n\n## [2025-11-03] 20:30:00",
        "new_text": "# 📋 Stock Analysis System - Change Log\n\n## [2025-11-07] 15:30:00\n### 📝 用户请求\n...新内容...\n---\n\n## [2025-11-03] 20:30:00",
        "replace_all": false
    }]
}
```

**操作要点：**
1. `original_text` 包含：文件标题 + 第一条原有记录的开头
2. `new_text` = 文件标题 + **新记录** + 分隔符 + 第一条原有记录的开头
3. 新记录"插入"在标题和首条记录之间
4. 原记录开头部分完整复制到 `new_text` 中

---

### ✅ 检查清单

每次修改 CHANGELOG.md 后必须自查：
- [ ] 新内容是否在最顶部（标题之后）？
- [ ] 原有内容的**每个字符**是否完全一致？
- [ ] 原有记录的顺序是否保持不变？
- [ ] 是否没有删除任何历史记录？
- [ ] 空行、缩进、Emoji 是否保持原样？

### 💡 记忆口诀

```
新内容插顶部，
旧内容不可动。
一字不改删，
顺序永不变。
```

### 📝 日志格式（四段式）

```markdown
## [日期] YYYY-MM-DD HH:mm:ss

### 📝 用户请求
记录用户的原始Prompt或需求描述（保持原样，不要改写）

### 🔧 处理过程
详细记录执行的步骤：
1. 分析了哪些文件/模块
2. 使用了什么方法/工具
3. 遇到的关键问题及解决方案
4. 重要的技术决策

### ✅ 处理结果
- **功能成果：** 实现了什么功能/修复了什么问题
- **文件变更：** 列出所有新增、修改、删除的文件
- **关键数据：** 性能指标、测试结果等（如适用）
- **后续建议：** 需要注意的事项或改进方向（可选）

### 🏷️  标签
`功能分类` `操作类型` `相关模块`

---
```

### 🏷️  标签分类体系

**功能分类：**
- `AI分析` `回测系统` `持仓管理` `数据源` `代理配置` `UI优化` `文档管理`

**操作类型：**
- `新增功能` `Bug修复` `性能优化` `重构` `测试` `配置变更`

**相关模块：**
- `modules/ai_service` `modules/backtest_engine` `modules/position_manager` `static/js` `templates` `工程规范`

### ⏰ 记录时机

**必须记录：**
- ✅ 代码修改（新增/修改/删除文件）
- ✅ 配置变更（修改 config、json、规则文件等）
- ✅ 功能开发/Bug修复
- ✅ 测试执行与结果
- ✅ 重构操作

**无需记录：**
- ❌ 纯查询性操作（查看文件内容、搜索代码）
- ❌ 答疑解惑（解释代码逻辑、提供建议）
- ❌ 单纯的文件浏览

